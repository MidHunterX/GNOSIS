{% extends 'gnosis/base.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% load tags %}
{% load tags%}
{% block content %}

<!-- {% block title %}{{q.title}}|{{block.super}}{% endblock %} -->
<!-- Button trigger modal -->

<!-- Modal -->
<div>
  <h2 class="display-6">Question Details</h2>
  <hr class="my-4">
  <div>
    <h2><p>Title: {{q.title}}</p></h2>
  <p><strong>Author: </strong><a href="{% url 'gnosis:profilepage' q.author %}">{{q.author}}</a>
      <span class="float-end">
        <span class="badge rounded-pill text-bg-secondary">Created: {{q.created}}</span>
        <span class="badge rounded-pill text-bg-secondary">Updated: {{q.updated}}</span>
        <span style="text-transform: uppercase;" class="badge rounded-pill text-bg-secondary">{{q.language}}</span>
      </span></p>
    <h4>Description:</h4><h6>{{q.body}}</h6>
  </div>
  <hr class="my-4">
  <div class="reaction">
    <form action="{% url 'gnosis:ques_likes' %}" method="POST">
      {% csrf_token %}
      {% if is_liked %}
      <button class="btn btn-danger" type="submit" name="q_id" value="{{ q.id }}"><i class="fas fa-thumbs-up"></i> Dislike <span class="badge badge-light">{{ likes_count }}</span></button>
      {% else %}
      <button class="btn btn-outline-danger" type="submit" name="q_id" value="{{ q.id }}"><i class="fa fa-thumbs-up"></i> Like <span class="badge badge-light">{{ likes_count }}</span></button>
      {% endif %}
    </form>
    <form action="{% url 'gnosis:ques_fav' %}" method="POST">
      {% csrf_token %}
      {% if is_favourite %}
      <button class="btn btn-warning" type="submit" name="q_id" value="{{ q.id }}"><i class="fas fa-star"></i> Remove from Favourites</button>
      {% else %}
      <button class="btn btn-outline-warning" type="submit" name="q_id" value="{{ q.id }}"><i class="fa fa-star"></i> Add to Favourites</button>
      {% endif %}
    </form>
  </div>


  <div class="reaction2">
    {% if request.user == q.author %}
    <a class="btn btn-outline-warning mb-2" href="{% url 'gnosis:update_ques' q.id %}"><i class="fas fa-edit"></i> Edit</a>

    <!-- Button trigger modal -->
    <button type="button" class="btn btn btn-outline-danger mb-2" data-bs-toggle="modal" data-bs-target="#deleteModal">
      <i class="fas fa-trash"></i> Delete
    </button>

    <!-- Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">Delete Question?</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete this Question?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary mb-2" data-bs-dismiss="modal">Close</button>
            <form method="POST" action="{% url 'gnosis:delete_ques' q.id %}">
              {% csrf_token %}
              <input class="btn btn-danger mb-2" type="submit" name="submit" value="Delete">
            </form>
          </div>
        </div>
      </div>
    </div>
    <!-- <a class="btn btn-outline-danger mb-2" href="{% url 'gnosis:delete_ques' q.id %}"><i class="fas fa-trash"></i> Delete</a> -->
    {% endif %}
  </div>
</div>

<hr class="my-4">
  {% if not q.restrict_comments %}
<h4>{{ comments.count}} Answers</h4>

<!-- COMMENTS SECTION -->
{% for comment in comments %}

<!-- MAIN COMMENT -->
<div class="d-flex p-4 border border-secondary rounded-4 shadow">
  <div alt="Comment Profile Picture">
    {% if comment.user.profile.photo %}
    <img class="rounded-circle" style="background-color: inherit;" src="{{ comment.user.profile.photo.url }}" height="64" width="64">
      {% else %}
    <img class="rounded-circle" style="background-color: inherit;" src="{% static 'comments.png' %}" height="64" width="64" alt="Generic placeholder image">
      {% endif %}
  </div>
  <div class="ms-4" alt="Comment Text">
    <h5 class="mt-0">
      <p><strong>@</strong><a href="{% url 'gnosis:profilepage' comment.user %}">{{comment.user}}</a>
        <span class="float-right">{{comment.timestamp}}</span>
      </p>
    </h5>
    <p>
      {{ comment.content }}
      {% if request.user == comment.user %}
    <form action="{% url 'gnosis:delete_comment' q.id %}" method="POST">
      {% csrf_token %}
      <button class="btn btn-outline-danger btn-sm" type="submit" name="comment_id" value="{{comment.id}}"><i class="fas fa-trash"></i> Delete</button>
    </form>
    {% endif %}
    </p>
  </div>
</div>


<!-- MAIN COMMENT REPLY SECTION -->
<div class="ms-5" alt="Reply Section for Main Comment">

  <!-- MAIN COMMENT REPLY FORM -->
  <form class="d-flex my-4" method="POST" action="{% url 'gnosis:comment_reply' q.id %}">
    {% csrf_token %}
    <input class="form-control me-2" type="text" placeholder="Comment!" name="text" value="">
    <button class="btn btn-outline-primary" type="submit" name="comment_id" value="{{comment.id}}"><b>Comment</b></button>
  </form>

  <!-- MAIN COMMENT REPLIES -->
  <!-- <h5>{{ replies|count_reply:comment}} Replies</h5> -->
  {% for reply in replies|in_category:comment %}
  <div class="d-flex p-4 mb-3 border border-1 border-tertiary rounded-4">
    <div alt="Reply Profile Picture">
      {% if reply.user.profile.photo %}
      <img class="rounded-circle" style="background-color: inherit;" src="{{ reply.user.profile.photo.url }}" height="64" width="64">
        {% else %}
      <img class="rounded-circle" style="background-color: inherit;" src="{% static 'comments.png' %}" height="64" width="64" alt="Generic placeholder image">
        {% endif %}
    </div>
    <div class="ms-4" alt="Reply Text">
      <h5 class="mt-0">
        <p><strong>@</strong><a href="{% url 'gnosis:profilepage' reply.user %}">{{reply.user}}</a>
          <span class="float-right">{{comment.timestamp}}</span>
        </p>
      </h5>
      <p>{{ reply.content }}</p>
        {% if request.user == reply.user %}
      <form action="{% url 'gnosis:delete_reply' q.id %}" method="POST">
        {% csrf_token %}
        <button class="btn btn-outline-danger btn-sm" type="submit" name="reply_id" value="{{reply.id}}"><i class="fas fa-trash"></i> Delete</button>
      </form>
      {% endif %}
    </div>
  </div>
  {% endfor %}
  <br>
</div>
{% endfor %} 

<!-- MAIN POST ANSWER FORM -->
<div id="uploaderMode">
  <h4>Add your answer below:</h4>
  <form method="POST">
    {% csrf_token %}
    {{ comment_form|crispy }}
    <button class="btn btn-outline-primary" type="submit" name="comment_id" value="{{comment.id}}"><i class="fas fa-comment"></i> Answer</button>
  </form>
  <br><br>
</div>

<!-- RESTRICTED: NO ANSWER FORM AND NO MAIN POST ANSWER -->
  {% else %}
<div class="alert alert-danger" role="alert">
  <h6><i class="fas fa-comment-slash"></i> Comments on this post are restricted!</h6>
</div>
{% endif %}

{% endblock %}
